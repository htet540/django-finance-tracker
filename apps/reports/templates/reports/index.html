{% extends "base.html" %}
{% load formatting %}
{% block title %}Reports{% endblock %}

{% block content %}
<h1 class="mb-3">Transaction Reports</h1>

<form method="get" class="card card-body mb-4">
  <div class="row g-3">
    <div class="col-md-2">
      <label class="form-label">Entity ID</label>
      {{ form.custom_id }}
    </div>
    <div class="col-md-3">
      <label class="form-label">Entity Name</label>
      {{ form.entity_name }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Type</label>
      {{ form.entity_type }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Location</label>
      {{ form.location }}
    </div>
    <div class="col-md-1">
      <label class="form-label">Currency</label>
      {{ form.currency }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Date From</label>
      {{ form.date_from }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Date To</label>
      {{ form.date_to }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Min Amount</label>
      {{ form.min_amount }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Max Amount</label>
      {{ form.max_amount }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Min MMK</label>
      {{ form.min_converted_mmk }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Max MMK</label>
      {{ form.max_converted_mmk }}
    </div>
    <div class="col-md-2">
      <label class="form-label">Sort</label>
      {{ form.order_by }}
    </div>
  </div>
  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary">Apply Filters</button>
    <a class="btn btn-outline-secondary" href="{% url 'reports:index' %}">Reset</a>

    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-dark" href="{% url 'reports:export_csv' %}?{{ request.GET.urlencode }}">CSV</a>
      <a class="btn btn-outline-success" href="{% url 'reports:export_xlsx' %}?{{ request.GET.urlencode }}">Excel</a>
      <a class="btn btn-outline-danger" href="{% url 'reports:export_pdf' %}?{{ request.GET.urlencode }}">PDF</a>
      <a class="btn btn-outline-danger" href="{% url 'reports:export_pdf' %}?landscape=1&{{ request.GET.urlencode }}">PDF (Landscape)</a>
    </div>
  </div>
</form>

<div class="d-flex justify-content-between align-items-center mb-2">
  <div>
    <strong>Total rows:</strong> {{ count }}
  </div>
  <div>
    <strong>Total Amount (original):</strong> {{ totals.total_amount|money:2 }}
    &nbsp; | &nbsp;
    <strong>Total MMK:</strong> {{ totals.total_mmk|money:2 }}
  </div>
</div>

<div class="table-responsive">
<table class="table table-striped table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>Date</th>
      <th>Entity</th>
      <th>Type</th>
      <th>Currency</th>
      <th class="text-end">Amount</th>
      <th class="text-end">Rate</th>
      <th class="text-end">MMK</th>
      <th>Purpose</th>
      <th>Location</th>
    </tr>
  </thead>
  <tbody>
    {% for t in page_obj.object_list %}
      <tr>
        <td>{{ t.date|date:"d/m/Y" }}</td>
        <td>{{ t.entity.custom_id }} · {{ t.entity.name }}</td>
        <td>{{ t.entity.get_type_display }}</td>
        <td>{{ t.currency.code }}</td>
        <td class="text-end">{{ t.amount|money:2 }}</td>
        <td class="text-end">{{ t.exchange_rate }}</td>
        <td class="text-end">{{ t.converted_amount_mmk|money:2 }}</td>
        <td>{{ t.designated_purpose }}</td>
        <td>{{ t.entity.location }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="9">No results.</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>

<nav>
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page=1&{{ request.GET.urlencode|cut:'page=' }}">« First</a></li>
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">‹ Prev</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">« First</span></li>
      <li class="page-item disabled"><span class="page-link">‹ Prev</span></li>
    {% endif %}

    <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>

    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">Next ›</a></li>
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode|cut:'page=' }}">Last »</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next ›</span></li>
      <li class="page-item disabled"><span class="page-link">Last »</span></li>
    {% endif %}
  </ul>
</nav>
{% endblock %}